"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[902],{7902:(e,t,a)=>{a.r(t),a.d(t,{ParallelExportEngine:()=>h});var o=a(2869),r=a(2547),i=a(2435),n=a(9221),s=a(4667),l=a(3911),c=a(5655);class d{async startExport(){if(console.log("\uD83D\uDD25\uD83D\uDD25\uD83D\uDD25 START_EXPORT METHOD CALLED - ENTRY POINT CONFIRMED \uD83D\uDD25\uD83D\uDD25\uD83D\uDD25"),console.log("\uD83D\uDD25 Timestamp:",new Date().toISOString()),console.log("\uD83D\uDD25 Export engine state:",{isExporting:this.isExporting,duration:this.duration}),this.isExporting)throw console.log("\uD83D\uDD25 Export already in progress - throwing error"),new l.ze("Export already in progress","EXPORT_IN_PROGRESS");try{var e,t;let a;console.log("\uD83D\uDE80 EXPORT INITIALIZATION DEBUG:"),console.log("1️⃣ Initial export duration (this.duration):",this.duration),console.log("2️⃣ Timeline elements count:",this.timelineElements.length),console.log("3️⃣ FPS setting:",this.fps);let o=this.calculateActualVideoDuration();console.log("\uD83C\uDFAC Export starting:",{timelineElements:this.timelineElements.length,calculatedDuration:this.duration,actualVideoDuration:o,fps:this.fps}),console.log("\uD83D\uDCCA DETAILED TIMELINE ELEMENTS ANALYSIS:"),this.timelineElements.forEach((e,t)=>{let a=e.trimStart||0,o=e.trimEnd||0,r=e.duration-a-o,i=(e.startTime||0)+e.duration-a-o;console.log("  Element ".concat(t+1,":"),{id:e.id,type:e.type,startTime:e.startTime,duration:e.duration,trimStart:a,trimEnd:o,effectiveDuration:r,elementEndTime:i,mediaId:"media"===e.type?e.mediaId:"N/A (text element)"}),o>0&&console.log("  \uD83D\uDEA8 TRIM END DETECTED: ".concat(o,"s - This may be causing duration reduction!")),r!==e.duration&&console.log("  \uD83D\uDEA8 EFFECTIVE DURATION DIFFERS: ".concat(r,"s vs original ").concat(e.duration,"s"))}),console.log("\uD83C\uDFA5 MEDIA ITEMS DURATION ANALYSIS:"),this.timelineElements.filter(e=>"media"===e.type).map((e,t)=>{let a=this.getMediaItem(e.mediaId),o={elementId:e.id,mediaId:e.mediaId,mediaType:null==a?void 0:a.type,sourceDuration:null==a?void 0:a.duration,timelineElementDuration:e.duration,durationMismatch:(null==a?void 0:a.duration)&&Math.abs(a.duration-e.duration)>.1};return console.log("  Media ".concat(t+1,":"),o),o}),console.log("⏱️ DURATION COMPARISON:"),this.duration,this.duration,this.duration,console.log("  Timeline duration:",this.duration),console.log("  Calculated video duration:",o),console.log("  Final export duration:",Math.min(this.duration,o+.1)),console.log("  Has significant mismatch:",Math.abs(this.duration-o)>.5);let i=Math.min(this.duration,o+.1);i!==this.duration?(console.log("\uD83D\uDEE0️ DURATION ADJUSTMENT DETECTED!"),console.log("   Original duration: ".concat(this.duration,"s")),console.log("   Safe duration: ".concat(i,"s")),console.log("   Difference: ".concat(this.duration-i,"s")),this.duration=i,console.log("✅ Export duration updated to: ".concat(this.duration,"s")),this.captureService=new r.$({fps:this.fps,duration:i,width:this.settings.width,height:this.settings.height},this.settings,this.timelineElements)):console.log("✅ No duration adjustment needed - using: ".concat(this.duration,"s")),this.performPreflightChecks(),console.log("✅ Preflight checks passed"),this.startMemoryMonitoring(),this.isExporting=!0,this.shouldCancel=!1,null==(e=this.onProgress)||e.call(this,0,"Initializing export..."),console.log("\uD83D\uDCF9 Starting video preload process..."),await this.preloadVideos(),console.log("\uD83D\uDCF9 Videos preloaded: ".concat(this.preloadedVideos.size," videos ready")),await this.prepareAudioTracks(),console.log("\uD83C\uDFB5 Audio tracks prepared");let s=await this.createAudioStream();return s&&(this.recorder.setAudioStream(s),console.log("\uD83C\uDFA4 Audio stream created")),await this.recorder.startRecording(),console.log("\uD83D\uDCF9 Recording started"),console.log("\uD83C\uDFAC Starting frame rendering..."),a=this.recorder instanceof n.T?await this.renderFramesOffline():await this.renderFrames(),console.log("✅ Export completed successfully!"),null==(t=this.onProgress)||t.call(this,100,"Export complete!"),a}catch(e){throw console.error("❌ Export failed:",e),this.handleExportError(e),e}finally{this.cleanupResources()}}cancelExport(){this.shouldCancel=!0,this.isExporting=!1,this.stopMemoryMonitoring();try{this.recorder.cleanup()}catch(e){console.warn("Failed to cleanup recorder:",e)}try{this.audioMixer.dispose()}catch(e){console.warn("Failed to dispose audio mixer:",e)}}async renderFrames(){return new Promise((e,t)=>{let a=this.captureService.getTotalFrames(),o=0,r=0,i=1e3/this.fps;console.log("\uD83C\uDFAC Starting frame rendering with precise timing:",{totalFrames:a,fps:this.fps,frameInterval:"".concat(i,"ms"),expectedDuration:"".concat(a/this.fps,"s")});let n=async s=>{if(this.shouldCancel)return void t(Error("Export cancelled"));if(o%30==0)try{this.checkMemoryStatus()}catch(e){t(e);return}if(o>=a){console.log("✅ All frames rendered, stopping recording"),this.recorder.stopRecording().then(e).catch(t);return}try{let e=this.captureService.getFrameData(o);console.log("\uD83C\uDF9E️ Rendering frame:",{frameNumber:o,timestamp:e.timestamp,targetInterval:"".concat(i,"ms")}),await this.renderSingleFrame(e);let t=Math.floor(o/a*100);if(t>r){var l;r=t;let e=c.aW.getMemorySummary();null==(l=this.onProgress)||l.call(this,t,"Rendering frame ".concat(o+1," of ").concat(a," (").concat(e,")"))}o++,setTimeout(()=>{n(performance.now())},i)}catch(e){t(e)}};n(performance.now())})}async renderFramesOffline(){var e,t;let a=this.captureService.getTotalFrames();for(let e=0;e<a;e++){if(this.shouldCancel)throw Error("Export cancelled");if(e%30==0)try{this.checkMemoryStatus()}catch(e){throw e}let o=this.captureService.getFrameData(e);await this.renderSingleFrame(o);let r=this.canvas.toDataURL("image/png");await this.recorder.addFrame(r,e);let i=Math.floor(e/a*100),n=c.aW.getMemorySummary();null==(t=this.onProgress)||t.call(this,i,"Rendering frame ".concat(e+1," of ").concat(a," (").concat(n,")"))}return null==(e=this.onProgress)||e.call(this,50,"Encoding video..."),this.recorder.stopRecording()}calculateActualVideoDuration(){return console.log("\uD83C\uDFAF Using timeline duration instead of recalculating:",this.duration),this.duration}async renderSingleFrame(e){if(!e||!e.elements)throw new l.$l("Invalid frame data provided",{frameNumber:-1,timestamp:-1,error:Error("frameData is undefined")});try{this.renderer.clearFrame(this.getBackgroundColor());let t=e.elements;for(let a of(0===t.length&&e.timestamp>0&&console.warn("⚠️ White frame at",e.timestamp,"s"),t))try{await this.renderElement(a,e.timestamp)}catch(e){console.warn("❌ Failed to render element ".concat(a.id,":"),e)}}catch(t){throw new l.$l("Failed to render frame ".concat(e.frameNumber),{frameNumber:e.frameNumber,timestamp:e.timestamp,error:t})}}async renderElement(e,t){let a=this.captureService.calculateElementBounds(e,this.settings.width,this.settings.height);this.renderer.save();try{switch(e.type){case"media":let o=this.getMediaItem(e.mediaId);o&&("video"===o.type?await this.renderVideoElement(e,a,t):"image"===o.type&&this.renderImageElement(e,a));break;case"text":this.renderTextElement(e,a);break;default:console.warn("Unknown element type: ".concat(e.type))}}finally{this.renderer.restore()}}async renderVideoElement(e,t,a){if("media"!==e.type)return void console.warn("❌ Element is not media type:",e.type);let o=this.getMediaItem(e.mediaId);if(!o||"video"!==o.type)return void console.warn("❌ Media item not found or not video:",o);let r=a-e.startTime+e.trimStart;if(r>=0&&r<=e.duration-e.trimStart-e.trimEnd)try{let e=this.preloadedVideos.get(o.id);if(e&&e.readyState>=1){console.log("\uD83C\uDFAC Using preloaded video",{readyState:e.readyState,duration:e.duration,currentTime:e.currentTime}),await this.seekVideoToTime(e,r);let o=a<.2?50:16;await new Promise(e=>setTimeout(e,o)),this.renderer.drawImage(e,t.x,t.y,t.width,t.height)}else{console.log("⏳ Video not preloaded or not ready",{hasPreloadedVideo:!!e,readyState:null==e?void 0:e.readyState,preloadedVideosCount:this.preloadedVideos.size,preloadedVideoIds:Array.from(this.preloadedVideos.keys())}),console.log("\uD83D\uDD04 Attempting fallback video creation...");try{let e=document.createElement("video");if(e.muted=!0,e.preload="auto",o.url?e.src=o.url:o.file&&(e.src=URL.createObjectURL(o.file)),await new Promise((t,a)=>{let o=!1,r=()=>{o||(o=!0,n(),console.log("\uD83C\uDFAC Fallback video can play, readyState: ".concat(e.readyState)),t())},i=()=>{o||(o=!0,n(),console.warn("❌ Fallback video load error"),a(Error("Video load failed")))},n=()=>{e.removeEventListener("canplay",r),e.removeEventListener("error",i),clearTimeout(s)};e.addEventListener("canplay",r),e.addEventListener("error",i);let s=setTimeout(()=>{o||(o=!0,n(),console.warn("⏰ Fallback video load timeout"),a(Error("Video load timeout")))},2e3);e.load()}),e.currentTime=r,await new Promise(t=>{let a=()=>{e.removeEventListener("seeked",a),t()};e.addEventListener("seeked",a),.1>Math.abs(e.currentTime-r)&&(e.removeEventListener("seeked",a),t())}),e.readyState>=2){console.log("✅ Fallback video ready, drawing frame"),this.renderer.drawImage(e,t.x,t.y,t.width,t.height);return}console.warn("⚠️ Fallback video readyState still low: ".concat(e.readyState))}catch(e){console.warn("❌ Fallback video creation failed:",e)}this.renderer.fillRect(t.x,t.y,t.width,t.height,"#666"),console.log("\uD83D\uDCE6 Drew placeholder rectangle for video")}}catch(e){console.warn("❌ Failed to draw video frame:",e),this.renderer.fillRect(t.x,t.y,t.width,t.height,"#f00"),console.log("\uD83D\uDD34 Drew error placeholder rectangle")}else console.log("⏭️ Skipping video render - outside element duration")}async seekVideoToTime(e,t){return new Promise((a,o)=>{let r=!1,i=()=>{r||(r=!0,console.log("✅ Video seeked to ".concat(t,"s, actualTime: ").concat(e.currentTime,", diff: ").concat(Math.abs(e.currentTime-t).toFixed(3),"s")),l(),a())},n=e=>{r||(r=!0,console.warn("❌ Video seek error:",e),l(),o(e))},s=()=>{!r&&.016>Math.abs(e.currentTime-t)&&(r=!0,console.log("✅ Video loaded data at ".concat(t,"s (via loadeddata), actualTime: ").concat(e.currentTime)),l(),a())},l=()=>{e.removeEventListener("seeked",i),e.removeEventListener("error",n),e.removeEventListener("loadeddata",s),clearTimeout(c)};e.addEventListener("seeked",i),e.addEventListener("error",n),e.addEventListener("loadeddata",s);let c=setTimeout(()=>{r||(r=!0,console.warn("⏰ Video seek timeout for time ".concat(t,"s")),l(),a())},1e3);if(.008>Math.abs(e.currentTime-t)){console.log("✅ Video already at ".concat(t,"s, skipping seek")),r=!0,l(),a();return}e.currentTime=t})}renderImageElement(e,t){if(console.log("\uD83D\uDDBC️ renderImageElement called:",{elementId:e.id,bounds:t}),"media"!==e.type)return void console.warn("❌ Element is not media type:",e.type);let a=this.getMediaItem(e.mediaId);if(!a||"image"!==a.type)return void console.warn("❌ Media item not found or not image:",a);console.log("\uD83D\uDDBC️ Image media item:",{id:a.id,name:a.name,hasUrl:!!a.url,hasFile:!!a.file});try{let e=document.createElement("img");e.src=a.url||(a.file?URL.createObjectURL(a.file):""),console.log("\uD83D\uDDBC️ Image element created:",{src:e.src,naturalWidth:e.naturalWidth,naturalHeight:e.naturalHeight}),this.renderer.drawImage(e,t.x,t.y,t.width,t.height),console.log("✅ Image drawn to canvas")}catch(e){console.warn("❌ Failed to draw image:",e)}}renderTextElement(e,t){e.content&&this.renderer.drawText(e.content,t.x,t.y,{fontSize:e.fontSize||24,color:e.color||"#000000",fontFamily:e.fontFamily||"Arial, sans-serif"})}getBackgroundColor(){return"#ffffff"}static async createDownloadLink(e,t){var a;if("showSaveFilePicker"in window)try{let a=await window.showSaveFilePicker({suggestedName:t,types:[{description:"Video files",accept:{"video/mp4":[".mp4"],"video/webm":[".webm"],"video/quicktime":[".mov"]}}]}),o=await a.createWritable();await o.write(e),await o.close();return}catch(e){}let o=URL.createObjectURL(e),r=document.createElement("iframe");r.style.display="none",document.body.appendChild(r);let i=r.contentDocument||(null==(a=r.contentWindow)?void 0:a.document);if(i){let e=i.createElement("a");e.href=o,e.download=t,i.body.appendChild(e),e.click(),i.body.removeChild(e)}setTimeout(()=>{document.body.removeChild(r),URL.revokeObjectURL(o)},1e3)}async prepareAudioTracks(){try{var e;for(let t of(null==(e=this.onProgress)||e.call(this,5,"Preparing audio tracks..."),this.audioMixer.clearTracks(),this.getAudioElements()))try{let e=await this.createAudioTrack(t);e&&this.audioMixer.addAudioTrack(e)}catch(e){console.warn("Failed to load audio track ".concat(t.id,":"),e)}}catch(e){throw new l.mo("Failed to prepare audio tracks",{error:e,elementCount:this.timelineElements.length})}}getAudioElements(){return this.timelineElements.filter(e=>{let t=e.type;return"audio"===t||"video"===t&&e.hasAudio})}async createAudioTrack(e){if(!e.src)return null;try{let t=await this.audioMixer.loadAudioBufferFromUrl(e.src),a=e.startTime||0,o=e.endTime||a+(e.duration||0),r=void 0!==e.volume?e.volume:1,i=void 0!==e.pan?e.pan:0;return{element:e,audioBuffer:t,startTime:a,endTime:o,volume:r,pan:i}}catch(t){return console.error("Failed to create audio track for ".concat(e.id,":"),t),null}}getAudioSources(){return this.getAudioElements().map(e=>({elementId:e.id,src:e.src||"",startTime:e.startTime||0,endTime:e.endTime||(e.startTime||0)+(e.duration||0),volume:void 0!==e.volume?e.volume:1,pan:void 0!==e.pan?e.pan:0}))}async createAudioStream(){try{var e;null==(e=this.onProgress)||e.call(this,10,"Mixing audio tracks...");let t=await this.audioMixer.mixTracks(),a=this.audioMixer.getAudioContext(),o=a.createBufferSource();o.buffer=t;let r=a.createMediaStreamDestination();return o.connect(r),o.start(),r.stream}catch(e){return console.warn("Failed to create audio stream:",e),null}}startMemoryMonitoring(){if(this.memoryMonitoringStarted)return;this.memoryMonitoringStarted=!0,c.aW.clearWarnings();let e=this.estimateProcessingSize(),t=c.aW.checkFileSafety(e);if(t){var a;if(console.warn("\uD83D\uDCBE File safety warning: ".concat(t.message)),!t.canContinue)throw new l.E3(t.message,{estimatedMB:e/1024/1024});null==(a=this.onProgress)||a.call(this,0,"⚠️ ".concat(t.message))}c.aW.startMonitoring(2e3),console.log("\uD83D\uDD0D Memory monitoring started - ".concat(c.aW.getMemorySummary()))}stopMemoryMonitoring(){this.memoryMonitoringStarted&&(this.memoryMonitoringStarted=!1,c.aW.stopMonitoring(),console.log("\uD83D\uDD0D Memory monitoring stopped - ".concat(c.aW.getMemorySummary())))}estimateProcessingSize(){return(0,c.Ml)(this.settings.width,this.settings.height,this.duration,this.fps)+44100*this.duration*4}checkMemoryStatus(){let e=c.aW.getMemoryInfo();if(!e)return;let t=c.aW.getRecentWarnings(1);if(t.length>0){let o=t[0];if("error"===o.level&&!o.canContinue)throw new l.E3(o.message,{usedPercent:e.usedPercent,recommendation:o.recommendation});if("critical"===o.level||"warning"===o.level){var a;null==(a=this.onProgress)||a.call(this,-1,"\uD83D\uDCBE ".concat(o.message," - ").concat(o.recommendation))}}}performPreflightChecks(){let e=(0,l.zG)();if(!e.supported)throw new l.pE("Browser not compatible: ".concat(e.issues.join(", ")),e.issues);let t=(0,l.$y)(this.settings.width,this.settings.height,this.duration,this.fps);if(!c.aW.canPerformOperation(t.estimatedMB))throw new l.E3("Export may exceed available memory (".concat(t.estimatedMB,"MB estimated)"),t);if(!this.canvas)throw new l.$l("Canvas not available for export");if(!this.timelineElements||0===this.timelineElements.length)throw new l.ze("No timeline elements to export","NO_CONTENT")}handleExportError(e){var t;let a;e instanceof Error?a=e:"string"==typeof e?a=Error(e):e&&"object"==typeof e?Object.assign(a=Error(e.message||e.toString()||"Unknown error object"),e):a=Error("Unknown error type: ".concat(typeof e,", value: ").concat(JSON.stringify(e))),(0,l.Te)(a,"ExportEngine.startExport");let o=(0,l.Ob)(a);null==(t=this.onError)||t.call(this,o)}cleanupResources(){this.isExporting=!1,this.stopMemoryMonitoring();try{this.recorder.cleanup()}catch(e){console.warn("Failed to cleanup recorder:",e)}try{this.audioMixer.dispose()}catch(e){console.warn("Failed to dispose audio mixer:",e)}try{this.preloadedVideos.forEach((e,t)=>{console.log("\uD83E\uDDF9 Cleaning up preloaded video: ".concat(t)),e.pause(),e.src="",e.load()}),this.preloadedVideos.clear()}catch(e){console.warn("Failed to cleanup preloaded videos:",e)}}get isActive(){return this.isExporting}async preloadVideos(){console.log("\uD83D\uDCF9 Starting video preload...");let e=new Set;this.timelineElements.forEach(t=>{if("media"===t.type){let a=this.getMediaItem(t.mediaId);(null==a?void 0:a.type)==="video"&&e.add(a.id)}});let t=Array.from(e);console.log("\uD83D\uDCF9 Found ".concat(t.length," unique video(s) to preload:"),t);let a=t.map(async e=>{let t=this.getMediaItem(e);return t&&"video"===t.type?(console.log("\uD83D\uDCF9 Preloading video: ".concat(t.name," (ID: ").concat(e,")")),new Promise(e=>{let a=document.createElement("video");if(a.muted=!0,a.crossOrigin="anonymous",a.preload="auto",t.url)a.src=t.url;else if(t.file)a.src=URL.createObjectURL(t.file);else{console.warn("❌ No source available for video: ".concat(t.name)),e();return}let o=!1,r=()=>{o||(o=!0,console.log("✅ Video fully preloaded: ".concat(t.name,", readyState: ").concat(a.readyState,", duration: ").concat(a.duration)),this.preloadedVideos.set(t.id,a),l(),e())},i=()=>{o||setTimeout(()=>{o||(o=!0,console.log("✅ Video ready (canplay): ".concat(t.name,", readyState: ").concat(a.readyState)),a.readyState>=2?this.preloadedVideos.set(t.id,a):console.warn("⚠️ Video readyState too low: ".concat(a.readyState,", not adding to preloaded videos")),l(),e())},1e3)},n=()=>{console.log("\uD83D\uDCCA Video metadata loaded: ".concat(t.name,", duration: ").concat(a.duration))},s=a=>{o||(o=!0,console.warn("❌ Failed to preload video: ".concat(t.name),a),l(),e())},l=()=>{a.removeEventListener("canplaythrough",r),a.removeEventListener("canplay",i),a.removeEventListener("loadedmetadata",n),a.removeEventListener("error",s),clearTimeout(c)};a.addEventListener("canplaythrough",r),a.addEventListener("canplay",i),a.addEventListener("loadedmetadata",n),a.addEventListener("error",s);let c=setTimeout(()=>{o||(o=!0,console.warn("⏰ Video preload timeout: ".concat(t.name,", readyState: ").concat(a.readyState)),a.readyState>=2&&(this.preloadedVideos.set(t.id,a),console.log("⚠️ Added partially loaded video: ".concat(t.name))),l(),e())},1e4);a.load(),a.addEventListener("loadedmetadata",()=>{console.log("\uD83D\uDCCA Metadata loaded, seeking to start: ".concat(t.name)),a.currentTime=0},{once:!0})})):void console.warn("❌ Video media item not found: ".concat(e))});await Promise.all(a),console.log("✅ Preload complete: ".concat(this.preloadedVideos.size," videos ready")),this.preloadedVideos.forEach((e,t)=>{console.log("\uD83D\uDCF9 Preloaded video ".concat(t,": readyState=").concat(e.readyState,", duration=").concat(e.duration))})}getMediaItem(e){return this.mediaItems.find(t=>t.id===e)}constructor(e){this.isExporting=!1,this.shouldCancel=!1,this.preloadedVideos=new Map,this.memoryMonitoringStarted=!1,console.log("\uD83C\uDFD7️ EXPORT ENGINE CONSTRUCTOR CALLED"),console.log("\uD83C\uDFD7️ Constructor duration:",e.duration),console.log("\uD83C\uDFD7️ Timeline elements count:",e.timelineElements.length),console.log("\uD83C\uDFD7️ Constructor options:",{duration:e.duration,fps:e.fps,timelineElementsCount:e.timelineElements.length}),this.canvas=e.canvas,this.settings=e.settings,this.timelineElements=e.timelineElements,this.mediaItems=e.mediaItems,this.duration=e.duration,this.fps=e.fps,this.onProgress=e.onProgress,this.onError=e.onError,this.renderer=new o.K(this.canvas,this.settings),this.captureService=new r.$({fps:this.fps,duration:this.duration,width:this.settings.width,height:this.settings.height},this.settings,this.timelineElements);let t=(0,n.D)();console.log("\uD83C\uDFA5 FFmpeg export enabled:",t,"env value:","true"),t?this.recorder=new n.T({settings:this.settings,fps:this.fps}):this.recorder=new i.g({canvas:this.canvas,settings:this.settings,fps:this.fps}),this.audioMixer=new s.A({sampleRate:44100,channels:2,duration:this.duration})}}var m=a(4999);class h extends d{calculateOptimalBatchSize(e){let t=e.availableGB;return this.getResolutionMultiplier(),Math.max(Math.min(Math.floor(1024*Math.min(.3*t,2)/(this.canvas.width*this.canvas.height*8/1048576)),2*(navigator.hardwareConcurrency||4),16),2)}getResolutionMultiplier(){let e=this.canvas.width*this.canvas.height;return e<=2073600?1:e<=3686400?1.5:2}async initializeCanvasPool(){console.log("\uD83C\uDFA8 Initializing ".concat(this.maxParallelCanvases," canvas pool...")),this.canvasPool=[],this.rendererPool=[];for(let e=0;e<this.maxParallelCanvases;e++){let e=document.createElement("canvas");e.width=this.canvas.width,e.height=this.canvas.height;let t=new o.K(e,this.settings);this.canvasPool.push(e),this.rendererPool.push(t)}console.log("✅ Canvas pool initialized with ".concat(this.canvasPool.length," canvases"))}async exportVideo(){try{console.log("\uD83D\uDE80 Starting parallel batch export..."),await this.initializeCanvasPool();let e=Math.ceil(this.duration*this.fps);console.log("\uD83D\uDCCA Exporting ".concat(e," frames at ").concat(this.fps,"fps")),await this.recorder.startRecording();let t=Date.now();await this.processFramesInParallel(e);let a=await this.recorder.stopRecording(),o=(Date.now()-t)/1e3;return console.log("✅ Parallel export completed in ".concat(o.toFixed(1),"s")),console.log("   - Performance: ".concat((e/o).toFixed(1)," fps")),a}catch(e){throw console.error("❌ Parallel export failed:",e),await this.cleanup(),e}}async processFramesInParallel(e){let t=0;for(;t<e;){var a;await this.memoryMonitor.checkMemoryDuringExport(t);let o=t,r=Math.min(t+this.batchSize,e),i=r-o;console.log("\uD83D\uDD04 Processing batch ".concat(o,"-").concat(r," (").concat(i," frames)"));let n=[];for(let e=0;e<i;e++){let t=o+e,a=e%this.maxParallelCanvases;n.push(this.renderFrameParallel(t,a))}for(let e of(await Promise.all(n)))this.frameBuffer.set(e.frameIndex,e);await this.streamBufferedFrames();let s=Math.floor((t=r)/e*100);null==(a=this.onProgress)||a.call(this,s,"Parallel processing: ".concat(t,"/").concat(e," frames")),t%(4*this.batchSize)==0&&await this.memoryMonitor.optimizeMemoryUsage()}await this.flushRemainingFrames()}async renderFrameParallel(e,t){try{let a=this.canvasPool[t];this.rendererPool[t];let o=a.getContext("2d"),r=e/this.fps;for(let e of(o.clearRect(0,0,a.width,a.height),this.timelineElements)){let t=e.startTime,a=e.startTime+e.duration-(e.trimStart||0)-(e.trimEnd||0);r>=t&&r<=a&&await this.renderElement(e,r)}let i=o.getImageData(0,0,a.width,a.height);return{frameIndex:e,imageData:i,timestamp:r}}catch(t){throw console.error("❌ Failed to render frame ".concat(e,":"),t),t}}async streamBufferedFrames(){for(;this.frameBuffer.has(this.currentWriteFrame);){let e=this.frameBuffer.get(this.currentWriteFrame);if(await this.addFrameToRecorder(e),this.frameBuffer.delete(this.currentWriteFrame),this.currentWriteFrame++,this.frameBuffer.size>this.maxBufferSize){console.warn("⚠️ Frame buffer overflow (".concat(this.frameBuffer.size,"), waiting..."));break}}}async flushRemainingFrames(){for(let[e,t]of(console.log("\uD83D\uDD04 Flushing ".concat(this.frameBuffer.size," remaining frames...")),Array.from(this.frameBuffer.entries()).sort((e,t)=>{let[a]=e,[o]=t;return a-o})))e>=this.currentWriteFrame&&(await this.addFrameToRecorder(t),this.currentWriteFrame=e+1);this.frameBuffer.clear()}async addFrameToRecorder(e){try{if("addFrame"in this.recorder)await this.recorder.addFrame(e.imageData);else{let t=document.createElement("canvas");t.width=e.imageData.width,t.height=e.imageData.height,t.getContext("2d").putImageData(e.imageData,0,0),await this.recorder.addFrame(t)}}catch(t){throw console.error("❌ Failed to add frame ".concat(e.frameIndex," to recorder:"),t),t}}async cleanup(){console.log("\uD83E\uDDF9 Cleaning up parallel export engine...");try{this.frameBuffer.clear(),this.canvasPool.length=0,this.rendererPool.length=0,await this.memoryMonitor.optimizeMemoryUsage(),console.log("✅ Parallel export engine cleanup completed")}catch(e){console.warn("⚠️ Cleanup warning:",e)}}getPerformanceMetrics(){let e=this.memoryMonitor.getMemoryStatus();return{batchSize:this.batchSize,maxParallelCanvases:this.maxParallelCanvases,memoryUsage:"".concat(e.currentUsageGB.toFixed(1),"GB / 8GB"),bufferSize:this.frameBuffer.size}}constructor(e){super(e),this.canvasPool=[],this.rendererPool=[],this.frameBuffer=new Map,this.currentWriteFrame=0,this.memoryMonitor=new m.l;let t=this.memoryMonitor.getMemoryStatus();this.maxParallelCanvases=this.calculateOptimalBatchSize(t),this.batchSize=this.maxParallelCanvases,this.maxBufferSize=Math.max(2*this.batchSize,20),console.log("\uD83D\uDE80 ParallelExportEngine initialized:"),console.log("   - Batch size: ".concat(this.batchSize," frames")),console.log("   - Max canvases: ".concat(this.maxParallelCanvases)),console.log("   - Memory buffer: ".concat(this.maxBufferSize," frames")),console.log("   - Available memory: ".concat(t.availableGB.toFixed(1),"GB"))}}}}]);